{% extends "base.html" %}

{% block title %}Analysis Result - Aneurysm Detection{% endblock %}

{% block content %}
<div class="result-page" id="result-container" data-analysis-id="{{ analysis_id }}">
    <div class="loading">Loading analysis...</div>
</div>

<script>
const analysisId = document.getElementById('result-container').dataset.analysisId;

fetch(`/api/analyses/${analysisId}`)
    .then(r => {
        if (!r.ok) throw new Error('Analysis not found');
        return r.json();
    })
    .then(data => {
        const resultClass = data.has_aneurysm ? 'detection-positive' : 'detection-negative';
        document.getElementById('result-container').innerHTML = `
            <div class="result-header">
                <h1>${data.original_filename}</h1>
                <span class="badge ${resultClass}">
                    ${data.has_aneurysm ? 'Aneurysm Detected' : 'Normal'}
                </span>
            </div>

            <div class="result-grid">
                <div class="image-section">
                    <h2>Original Image</h2>
                    <img src="/api/analyses/${data.id}/image" alt="Original" class="result-image">
                </div>

                ${data.visualization_path ? `
                <div class="image-section">
                    <h2>Detection Visualization</h2>
                    <img src="/api/analyses/${data.id}/visualization" alt="Visualization" class="result-image">
                </div>
                ` : ''}
            </div>

            <div class="result-details-grid">
                <div class="detail-card">
                    <h3>Detection Results</h3>
                    <dl>
                        <dt>Result</dt>
                        <dd>${data.has_aneurysm ? 'Aneurysm Detected' : 'Normal'}</dd>
                        <dt>Confidence</dt>
                        <dd>${(data.max_confidence * 100).toFixed(1)}%</dd>
                        <dt>Detections</dt>
                        <dd>${data.num_detections}</dd>
                    </dl>
                </div>

                <div class="detail-card">
                    <h3>Processing Times</h3>
                    <dl>
                        <dt>Preprocessing</dt>
                        <dd>${data.preprocess_time_ms?.toFixed(1) || '-'}ms</dd>
                        <dt>Inference</dt>
                        <dd>${data.inference_time_ms?.toFixed(1) || '-'}ms</dd>
                        <dt>Postprocessing</dt>
                        <dd>${data.postprocess_time_ms?.toFixed(1) || '-'}ms</dd>
                        <dt>Total</dt>
                        <dd>${data.total_time_ms?.toFixed(1) || '-'}ms</dd>
                    </dl>
                </div>

                <div class="detail-card">
                    <h3>File Info</h3>
                    <dl>
                        <dt>Original Name</dt>
                        <dd>${data.original_filename}</dd>
                        <dt>Size</dt>
                        <dd>${data.file_size_bytes ? (data.file_size_bytes / 1024).toFixed(1) + ' KB' : '-'}</dd>
                        <dt>Analyzed</dt>
                        <dd>${new Date(data.created_at).toLocaleString()}</dd>
                    </dl>
                </div>
            </div>

            <div class="notes-section">
                <h3>Notes</h3>
                <form hx-put="/api/analyses/${data.id}/notes"
                      hx-trigger="submit"
                      hx-swap="none">
                    <textarea name="notes" placeholder="Add notes about this analysis...">${data.notes || ''}</textarea>
                    <button type="submit" class="btn btn-secondary">Save Notes</button>
                </form>
            </div>

            <div class="result-actions">
                <a href="/analyses" class="btn btn-secondary">Back to History</a>
                <a href="/upload" class="btn btn-primary">Analyze Another</a>
                <button onclick="deleteAnalysis(${data.id})" class="btn btn-danger">Delete</button>
            </div>
        `;
    })
    .catch(err => {
        document.getElementById('result-container').innerHTML = `
            <div class="error">
                <h2>Error</h2>
                <p>${err.message}</p>
                <a href="/analyses" class="btn btn-secondary">Back to History</a>
            </div>
        `;
    });

function deleteAnalysis(id) {
    if (!confirm('Are you sure you want to delete this analysis?')) return;

    fetch(`/api/analyses/${id}`, { method: 'DELETE' })
        .then(r => {
            if (r.ok) {
                window.location.href = '/analyses';
            } else {
                alert('Failed to delete analysis');
            }
        });
}
</script>
{% endblock %}
